function Game(){_currentPlayer=null;this.levelFileNames=["blocks.js","theReturnOfBlocks.js","levelThree.js","multiplicity.js","traps.js","trees.js",];this.currentLevel=0;this.setCurrentPlayer=function(a){_currentPlayer=a};this.getCurrentPlayer=function(){return _currentPlayer};this.init=function(){this.display=new ROT.Display({width:dimensions.width,height:dimensions.height,fontFamily:'"droid sans mono", monospace',fontSize:20,});this.display.setupEventHandlers();$("#screen").append(this.display.getContainer());this.output=new ROT.Display({width:dimensions.width*1.33,height:2,fontFamily:'"droid sans mono", monospace',fontSize:15});$("#output").append(this.output.getContainer());this.map=new Map(this.display);_currentPlayer=new Player(-1,-1,this.map);this.editor=createEditor("editor","",600,500);this.getLevel(this.currentLevel);this.display.focus();shortcut.add("ctrl+1",function(){game.display.focus();return true});shortcut.add("ctrl+2",function(){game.editor.focus();return true});shortcut.add("ctrl+3",function(){return true});shortcut.add("ctrl+4",function(){game.resetEditor();return true});shortcut.add("ctrl+5",function(){game.evalLevelCode();return true});shortcut.add("ctrl+6",function(){game.usePhone();return true})};this.moveToNextLevel=function(){var a=this;this.currentLevel++;this.display.fadeOut(this.map,function(){a.getLevel(a.currentLevel)})};this.getLevel=function(b){var a=this;this.currentLevel=b;var c;if(b<this.levelFileNames.length){c=this.levelFileNames[b]}else{c="dummyLevel.js"}$.get("levels/"+c,function(d){if(a.editor){a.editor.toTextArea()}a.loadLevel(d,b)})};this.loadLevel=function(b,a){this.editor=createEditor("editor",b,600,500);this.evalLevelCode(a);if(a<this.levelFileNames.length){this.display.fadeIn(this.map)}if(this.currentLevel==0){this.output.write("Dr. Eval awoke in a strange dungeon, with no apparent way out. He spied his trusty computer ...")}};this.resetEditor=function(){this.getLevel(this.currentLevel)};this.evalLevelCode=function(b){var c=this.editor.getValue();var g=this.editor.getPlayerCode();var f=this.validate(c,g,this.currentLevel);if(f){this.map.reset();var e=this.map;var d=this.display;var a=this.output;f(e);_currentPlayer=this.map.getPlayer();if(b>=this.levelFileNames.length){return}this.display.drawAll(e)}};this.usePhone=function(){if(this.map.getPlayer()._phoneFunc){this.map.getPlayer()._phoneFunc()}else{this.output.write("RotaryPhoneException: Your function phone is not bound to any function.")}};this.init()}ROT.Display.prototype.setupEventHandlers=function(){var a={37:"left",38:"up",39:"right",40:"down"};$(this.getContainer()).attr("contentEditable","true");this.getContainer().addEventListener("keydown",function(b){if(a[b.keyCode]){game.map.getPlayer().move(a[b.keyCode])}});this.getContainer().addEventListener("click",function(b){$(this).addClass("focus");$(".CodeMirror").removeClass("focus")})};ROT.Display.prototype.drawObject=function(a,g,c,f,d){var e=game.objects[c].symbol;var b;if(game.objects[c].color){b=game.objects[c].color}else{b="#fff"}if(!f){f="#000"}if(d){b=ROT.Color.toHex(ROT.Color.multiply(d,ROT.Color.fromString(b)));f=ROT.Color.toHex(ROT.Color.multiply(d,ROT.Color.fromString(f)))}this.draw(a,g,e,b,f)};ROT.Display.prototype.drawAll=function(c,b){for(var a=0;a<dimensions.width;a++){for(var d=0;d<dimensions.height;d++){this.drawObject(a,d,c.getGrid()[a][d].type,c.getGrid()[a][d].bgColor,b)}}if(c.getPlayer()){c.getPlayer().draw()}};ROT.Display.prototype.fadeOut=function(c,d,a){var b=this;if(a<=0){if(d){d()}}else{if(!a){a=255}this.drawAll(c,[a,a,a]);setTimeout(function(){b.fadeOut(c,d,a-10)},10)}};ROT.Display.prototype.fadeIn=function(c,d,a){var b=this;if(a>255){if(d){d()}}else{if(!a){a=0}this.drawAll(c,[a,a,a]);setTimeout(function(){b.fadeIn(c,d,a+5)},10)}};ROT.Display.prototype.write=function(a){this.clear();this.drawText(0,0,a)};ROT.Display.prototype.focus=function(){$(this.getContainer()).attr("tabindex","0").click().focus()};function createEditor(f,g,a,k){var e=CodeMirror.fromTextArea(document.getElementById(f),{theme:"vibrant-ink",lineNumbers:true,dragDrop:false,extraKeys:{Enter:function(i){var j=i.getCursor();j.line++;i.setCursor(j)}}});e.setSize(a,k);e.setValue(g);e.on("focus",function(i){$(".CodeMirror").addClass("focus");$("#screen canvas").removeClass("focus")});this.editableLines=[];if(g&&g!=""){var b=g.split("\n")[0];var h=JSON.parse(b.slice(3)).editable;for(var c=0;c<h.length;c++){range=h[c];for(var d=range[0];d<=range[1];d++){this.editableLines.push(d-1)}}e.removeLine(0);e.on("beforeChange",function(j,m){if(this.editableLines.indexOf(m.to.line)==-1){m.cancel();return}else{if(m.origin=="+delete"){if(m.to.line!=m.from.line){m.cancel()}}else{if(m.text.length>1){m.text=[m.text[0]]}var i=j.getLine(m.to.line).length;if(i+m.text[0].length>80){var l=Math.max(80-i,0);m.text[0]=m.text[0].substr(0,l)}}}console.log(m)});e.on("update",function(j){for(var l=0;l<j.lineCount();l++){if(this.editableLines.indexOf(l)==-1){j.addLineClass(l,"wrap","disabled")}}});e.refresh()}return e}CodeMirror.prototype.getPlayerCode=function(){var b="";for(var a=0;a<this.lineCount();a++){if(this.editableLines&&this.editableLines.indexOf(a)>-1){b+=game.editor.getLine(a)+" \n"}}return b};var dimensions={width:50,height:25};function Map(c){var b;var a;this.reset=function(){this.display.clear();a=new Array(dimensions.width);for(var d=0;d<dimensions.width;d++){a[d]=new Array(dimensions.height);for(var e=0;e<dimensions.height;e++){a[d][e]={type:"empty"}}}b=null};this.getPlayer=function(){return b};this.getGrid=function(){return a};this.getWidth=function(){return dimensions.width};this.getHeight=function(){return dimensions.height};this.placeObject=function(d,g,e,f){if(typeof(a[d])!=="undefined"&&typeof(a[d][g])!=="undefined"){if(!b.atLocation(d,g)||e=="empty"){a[d][g].type=e}}};this.placePlayer=function(d,e){if(b){throw"Can't place player twice!"}b=new Player(d,e,this);b.draw()};this.setSquareColor=function(d,f,e){a[d][f].bgColor=e};this.canMoveTo=function(d,e){if(d<0||d>=dimensions.width||e<0||e>=dimensions.height){return false}return !(game.objects[this.getGrid()[d][e].type].impassable)};this.display=c;this.reset()}Game.prototype.objects={empty:{symbol:" "},player:{symbol:"@",color:"#0f0"},exit:{symbol:String.fromCharCode(9109),color:"#0ff",onCollision:function(a){game.moveToNextLevel()}},block:{symbol:"#",color:"#f00",impassable:true},tree:{symbol:"♣",color:"#080",impassable:true},trap:{symbol:" ",onCollision:function(a){game.map.getPlayer().killedBy("an invisible trap")}},stream:{symbol:"░",onCollision:function(a){game.map.getPlayer().killedBy("drowning in deep dark water")}},computer:{type:"item",symbol:String.fromCharCode(8984),color:"#ccc",onPickUp:function(a){game.output.write("You have picked up the computer! You can use it to get past the walls to the exit.");$("#editorPane").fadeIn();game.editor.refresh()}},phone:{type:"item",symbol:String.fromCharCode(9742),onPickUp:function(a){game.output.write("You have picked up the function phone! You can use it to call functions, as defined by setPhoneCallback in the level code.");$("#phoneButton").show()}}};function Player(a,f,e){var c=a;var b=f;var d=[];this._rep="@";this._fgColor="#0f0";this._map=e;this._display=this._map.display;this.getX=function(){return c};this.getY=function(){return b};this.draw=function(){var g=this._map.getGrid()[c][b].bgColor;this._display.draw(c,b,this._rep,this._fgColor,g)};this.atLocation=function(g,h){return(c===g&&b===h)};this.move=function(i){var k=c;var j=b;var h;var g;if(i==="up"){h=k;g=j-1}else{if(i==="down"){h=k;g=j+1}else{if(i==="left"){h=k-1;g=j}else{if(i==="right"){h=k+1;g=j}}}}if(this._map.canMoveTo(h,g)){this._display.drawObject(k,j,this._map.getGrid()[k][j].type,this._map.getGrid()[k][j].bgColor);c=h;b=g;this.draw();this.afterMove(c,b)}};this.afterMove=function(g,j){var i=this._map.getGrid()[g][j].type;var h=game.objects[i];if(h.type=="item"){this.pickUpItem(i,h)}else{if(h.onCollision){h.onCollision(this)}}};this.killedBy=function(g){alert("You have been killed by "+g+"!");getLevel(currentLevel)};this.pickUpItem=function(h,g){d.push(h);e.placeObject(c,b,"empty");this.move("left");this.move("right");if(g.onPickUp){g.onPickUp(this)}};this.hasItem=function(g){return d.indexOf(g)>-1};this.setPhoneCallback=function(g){this._phoneFunc=g}}var VERBOTEN=["eval","prototype","delete","return","moveToNextLevel"];var DummyDisplay=function(){this.clear=function(){};this.draw=function(){};this.drawObject=function(){}};Game.prototype.validate=function(allCode,playerCode,level){function validateAtLeastXObjects(map,num,type){var count=0;for(var x=0;x<map.getWidth();x++){for(var y=0;y<map.getHeight();y++){if(map.getGrid()[x][y].type===type){count++}}}if(count<num){throw"Not enough "+type+"s on the map! Expected: "+num+", found: "+count}}function validateExactlyXManyObjects(map,num,type){var count=0;for(var x=0;x<map.getWidth();x++){for(var y=0;y<map.getHeight();y++){if(map.getGrid()[x][y].type===type){count++}}}if(count!=num){throw"Wrong number of "+type+"s on the map! Expected: "+num+", found: "+count}}validateLevel=function(){};this.output.clear();try{for(var i=0;i<VERBOTEN.length;i++){var badWord=VERBOTEN[i];if(playerCode.indexOf(badWord)>-1){throw"You are not allowed to use "+badWord+"!"}}var display=this.display;var output=this.output;var dummyMap=new Map(new DummyDisplay);eval(allCode);startLevel(dummyMap);if(typeof(validateLevel)!="undefined"){validateLevel(dummyMap)}return startLevel}catch(e){this.output.drawText(0,0,e.toString());throw e}};